<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MHK SEA HS Student Locator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="google-signin-client_id" content="744383002320-gq27ob1mgqncf8eqgs1gn7t60toe3gjq.apps.googleusercontent.com">

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; text-align: center; }
    #login-container { margin-top: 120px; }
    #app-container { padding: 20px; display: none; }
    #search-box { width: 60%; padding: 12px; font-size: 18px; border-radius: 8px; border: 1px solid #aaa; }
    #suggestions {
        width: 60%; margin: 0 auto; background: white; border: 1px solid #ccc;
        border-top: none; display: none; max-height: 200px; overflow-y: auto;
        text-align: left; position: relative; z-index: 999;
    }
    #suggestions div { padding: 10px; cursor: pointer; }
    #suggestions div:hover { background: #eee; }
    #location-box {
        margin-top: 40px; display: inline-block; background: red; color: white;
        padding: 35px; font-size: 30px; font-weight: bold; border-radius: 12px; min-width: 300px;
    }
</style>

</head>
<body>

<div id="login-container">
    <h1>MHK SEA HS Student Locator</h1>
    <h3>Please sign in with your Boston Public Schools account</h3>

    <div id="g_id_onload"
        data-client_id="744383002320-gq27ob1mgqncf8eqgs1gn7t60toe3gjq.apps.googleusercontent.com"
        data-context="signin"
        data-ux_mode="popup"
        data-callback="onSignIn"
        data-auto_prompt="false"></div>

    <div class="g_id_signin"
        data-type="standard"
        data-size="large"
        data-theme="outline"></div>
</div>

<div id="app-container">
    <h1>Where Should This Student Be?</h1>

    <input id="search-box" type="text" placeholder="Search student name..." autocomplete="off">
    <div id="suggestions"></div>

    <div id="location-box">Search for a student</div>
</div>

<script>
function decodeJwtResponse(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const decodedData = JSON.parse(decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join('')));
    return decodedData;
}

function onSignIn(response) {
    const data = decodeJwtResponse(response.credential);
    const email = data.email;

    console.log("User email:", email);

    if (!email.endsWith("@bostonpublicschools.org")) {
        alert("Access denied: You must use a @bostonpublicschools.org email.");
        google.accounts.id.disableAutoSelect();
        location.reload();
        return;
    }

    document.getElementById("login-container").style.display = "none";
    document.getElementById("app-container").style.display = "block";
}

const scheduleData = {
    "Doe, John": [
        { time: "7:20-7:35", location: "Homeroom 103" },
        { time: "7:36-8:30", location: "Math 204" }
    ],
};

function addHomeBlocks() {
    const homeBlock = { time: "1:41pm - 7:19am", location: "Home" };
    for (let student in scheduleData) {
        scheduleData[student].push(homeBlock);
    }
}
addHomeBlocks();

const searchBox = document.getElementById("search-box");
const suggestions = document.getElementById("suggestions");

searchBox.addEventListener("input", function () {
    const query = this.value.toLowerCase();
    suggestions.innerHTML = "";

    if (!query) { suggestions.style.display = "none"; return; }

    const matches = Object.keys(scheduleData).filter(name =>
        name.toLowerCase().includes(query)
    );

    if (matches.length === 0) { suggestions.style.display = "none"; return; }

    matches.forEach(name => {
        const div = document.createElement("div");
        div.textContent = name;
        div.onclick = () => {
            searchBox.value = name;
            suggestions.style.display = "none";
            showLocation(name);
        };
        suggestions.appendChild(div);
    });

    suggestions.style.display = "block";
});

function getCurrentMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
}

function parseTimeRange(range) {
    const parts = range.replaceAll(" ", "").split("-");
    return parts.map(t => {
        let [hour, minute] = t.split(":").map(Number);
        return hour * 60 + minute;
    });
}

function showLocation(studentName) {
    const now = getCurrentMinutes();
    let result = "No schedule found";

    for (let entry of scheduleData[studentName]) {
        const [start, end] = parseTimeRange(entry.time);
        if (now >= start && now <= end) {
            result = entry.location;
            break;
        }
    }

    document.getElementById("location-box").textContent = result;
}
</script>

</body>
</html>
