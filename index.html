<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MHK SEA HS â€” Student Locator</title>
<meta name="google-signin-client_id" content="744383002320-gq27ob1mgqncf8eqgs1gn7t60toe3gjq.apps.googleusercontent.com">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;margin:0;padding:20px;display:flex;justify-content:center;}
  .container{width:100%;max-width:920px;}
  header{text-align:center;margin-bottom:14px;}
  h1{margin:8px 0;}
  #login-container{text-align:center;margin-top:40px;}
  .card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.06);}
  .controls{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;position:relative;margin-top:12px;}
  #search{width:60%;min-width:260px;padding:12px 14px;font-size:16px;border-radius:8px;border:1px solid #ccd8e6;}
  #voiceBtn{padding:10px 14px;font-size:16px;border-radius:8px;background:#fff;border:1px solid #ccd8e6;cursor:pointer;}
  #checkBtn{padding:10px 14px;font-size:16px;border-radius:8px;background:#d33;color:#fff;border:0;cursor:pointer;}
  #suggestions{position:absolute;top:56px;left:50%;transform:translateX(-50%);width:60%;max-width:640px;background:#fff;border:1px solid #e6eef8;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.06);display:none;max-height:260px;overflow:auto;z-index:2000;}
  .sugg{padding:10px 12px;border-bottom:1px solid #f2f4f8;cursor:pointer;}
  .sugg:hover{background:#f7f9ff}
  #locationBox{margin:26px auto 0;padding:28px;width:60%;max-width:680px;background:#d33;color:#fff;border-radius:12px;font-size:20px;font-weight:700;display:none;text-align:center;}
  #fullSchedule{margin:18px auto 0;width:70%;max-width:720px;background:#fff;border-radius:8px;padding:12px;display:none;text-align:left;box-shadow:0 6px 18px rgba(0,0,0,0.04);}
  .small{font-size:14px;color:#6b7a90;text-align:center;margin-top:10px}
  @media (max-width:640px){#locationBox{width:90%;padding:18px;font-size:18px}#search{width:90%}#suggestions{width:90%;left:50%;transform:translateX(-50%)}#fullSchedule{width:90%}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>MHK SEA HS â€” Student Locator</h1>
    <div class="small">Sign in with your Boston Public Schools account to use the app.</div>
  </header>
  <div class="card">
    <div id="login-container">
      <div id="g_id_onload"
           data-client_id="744383002320-gq27ob1mgqncf8eqgs1gn7t60toe3gjq.apps.googleusercontent.com"
           data-context="signin"
           data-ux_mode="popup"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false"></div>
      <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"></div>
    </div>
    <div id="app" style="display:none;">
      <div class="controls" role="region" aria-label="Search controls">
        <input id="search" placeholder="Type student first or last nameâ€¦" autocomplete="off" />
        <button id="voiceBtn" title="Voice search">ðŸŽ¤</button>
        <button id="checkBtn">Check Now</button>
        <div id="suggestions" role="listbox"></div>
      </div>
      <div id="locationBox" role="status" aria-live="polite">Where the student should be will appear here</div>
      <div style="text-align:center;margin-top:14px;">
        <button id="toggleSchedule">View full schedule</button>
      </div>
      <div id="fullSchedule"></div>
    </div>
  </div>
  <p class="small">Built from uploaded schedule. Only current location shown by default. Full schedule available on demand.</p>
</div>

<script>
let SCHEDULE = {};
fetch('cleaned_schedule.json').then(r=>r.json()).then(json=>{ SCHEDULE = json; names = Object.keys(SCHEDULE).sort((a,b)=>a.localeCompare(b)); })
.catch(e=>console.error('Could not load schedule JSON', e));

function decodeJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

function handleCredentialResponse(resp) {
  try {
    const info = decodeJwt(resp.credential);
    const email = info.email || '';
    if (!email.endsWith('@bostonpublicschools.org')) {
      alert('Access denied â€” use your @bostonpublicschools.org account.');
      google.accounts.id.disableAutoSelect();
      return;
    }
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initApp();
  } catch (e) {
    console.error(e);
    alert('Sign-in failed');
  }
}

const search = document.getElementById('search');
const suggestions = document.getElementById('suggestions');
const voiceBtn = document.getElementById('voiceBtn');
const checkBtn = document.getElementById('checkBtn');
const locationBox = document.getElementById('locationBox');
const fullScheduleDiv = document.getElementById('fullSchedule');
const toggleBtn = document.getElementById('toggleSchedule');

let names = [];
let visibleSuggestionIndex = -1;

function initApp(){
  names = Object.keys(SCHEDULE).sort((a,b)=>a.localeCompare(b));
  document.getElementById('search').focus();
}

search.addEventListener('input', ()=>{
  const q = search.value.trim().toLowerCase();
  suggestions.innerHTML = '';
  visibleSuggestionIndex = -1;
  if(!q || names.length===0){ suggestions.style.display='none'; return; }
  const matches = names.filter(n=> n.toLowerCase().includes(q)).slice(0,12);
  matches.forEach(n=>{
    const div = document.createElement('div');
    div.className='sugg';
    div.textContent = n;
    div.onclick = ()=> { selectName(n); };
    suggestions.appendChild(div);
  });
  suggestions.style.display = matches.length? 'block':'none';
});

search.addEventListener('keydown', (e)=>{
  const items = suggestions.querySelectorAll('.sugg');
  if(e.key==='ArrowDown'){ e.preventDefault(); visibleSuggestionIndex = Math.min(visibleSuggestionIndex+1, items.length-1); updateHighlight(); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); visibleSuggestionIndex = Math.max(visibleSuggestionIndex-1, 0); updateHighlight(); }
  else if(e.key==='Enter'){ e.preventDefault(); if(visibleSuggestionIndex>=0 && items[visibleSuggestionIndex]) selectName(items[visibleSuggestionIndex].textContent); else selectName(search.value); }
});

function updateHighlight(){
  const items = suggestions.querySelectorAll('.sugg');
  items.forEach((it,i)=> it.style.background = i===visibleSuggestionIndex? '#eef4ff':'');
  if(visibleSuggestionIndex>=0 && items[visibleSuggestionIndex]) items[visibleSuggestionIndex].scrollIntoView({block:'nearest'});
}

function selectName(name){
  search.value = name;
  suggestions.innerHTML=''; suggestions.style.display='none';
  showCurrentLocation(name);
}

function parseRange(range){
  const m = range.match(/(\d{1,2}:\d{2})\s*(am|pm)?\s*-\s*(\d{1,2}:\d{2})\s*(am|pm)?/i);
  if(!m) return null;
  return [toMin(m[1], m[2]), toMin(m[3], m[4])];
}
function toMin(hm, ampm){
  let parts = hm.split(':').map(Number);
  let h = parts[0], m = parts[1]||0;
  if(ampm){ ampm = ampm.toLowerCase(); if(ampm==='pm' && h!==12) h+=12; if(ampm==='am' && h===12) h=0; }
  return h*60 + m;
}
function nowMin(){ const d=new Date(); return d.getHours()*60 + d.getMinutes(); }

function showCurrentLocation(name){
  locationBox.style.display='none';
  if(!SCHEDULE[name]){ locationBox.textContent='Student not found'; locationBox.style.display='block'; return; }
  const nowDay = new Date().toLocaleString('en-US',{weekday:'long'});
  const entries = SCHEDULE[name] || [];
  const now = nowMin();
  let found = null;
  for(const e of entries){
    if(e.day !== nowDay) continue;
    const rng = parseRange(e.time);
    if(!rng) continue;
    const [s,eT] = rng;
    if(s<=eT){ if(now>=s && now<=eT){ found = e; break; } }
    else { if(now>=s || now<=eT){ found = e; break; } }
  }
  locationBox.textContent = found? found.location : 'No scheduled class right now';
  locationBox.style.display = 'block';
  renderFullSchedule(name);
}

function renderFullSchedule(name){
  const entries = SCHEDULE[name] || [];
  fullScheduleDiv.innerHTML = '';
  if(entries.length===0){ fullScheduleDiv.innerHTML='<div>No schedule available</div>'; return; }
  const order = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
  order.forEach(day=>{
    const dayEntries = entries.filter(e=> e.day===day);
    if(dayEntries.length){
      const h = document.createElement('h3'); h.textContent = day; fullScheduleDiv.appendChild(h);
      dayEntries.forEach(en=>{
        const div = document.createElement('div'); div.textContent = `${en.time} â€” ${en.location}`;
        fullScheduleDiv.appendChild(div);
      });
    }
  });
}

toggleBtn.addEventListener('click', ()=>{
  if(fullScheduleDiv.style.display==='block'){ fullScheduleDiv.style.display='none'; toggleBtn.textContent='View full schedule'; }
  else{ fullScheduleDiv.style.display='block'; toggleBtn.textContent='Hide full schedule'; }
});

checkBtn.addEventListener('click', ()=>{ const q = search.value.trim(); if(q) showCurrentLocation(q); });

voiceBtn.addEventListener('click', ()=>{
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!Rec){ alert('Voice not supported in this browser'); return; }
  const r = new Rec(); r.lang='en-US'; r.interimResults=false; r.maxAlternatives=1;
  r.onresult = ev => {
    const txt = ev.results[0][0].transcript;
    const q = txt.trim().toLowerCase();
    const exact = names.find(n=> n.toLowerCase()===q);
    const incl = names.find(n=> n.toLowerCase().includes(q));
    const found = exact || incl;
    if(found){ selectName(found); } else { alert('No matching student for "'+txt+'"'); }
  };
  r.onerror = ()=>{ alert('Voice recognition error'); };
  r.start();
});

</script>
</body>
</html>
